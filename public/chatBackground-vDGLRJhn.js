import{p as ht,a7 as Q,az as U,c as E,ez as lt,aA as N,cr as dt,a1 as J,m as R,bU as mt,aW as Z,dd as tt,aO as ut,bM as gt,aa as ft,dz as _t,fl as pt,f9 as xt,b7 as vt,fm as M,cK as Pt,bx as H,dE as Ct,a6 as wt,i as L,a as X,a0 as q,ba as Tt,t as et,bj as Et,dL as St,a2 as yt,cV as It}from"./index-DZ3NJB4a.js";import{a as Lt,c as bt}from"./classNames-CjRVkFnK.js";function Qt(s,e){if(s.focus(),ht(s),e){const t=new KeyboardEvent(e.type,e);s.dispatchEvent(t)}}function At(s){return Q(()=>{const e=s.name||"s";return{enterActive:(s.enterActiveClass||e+"-enter-active").split(" "),enter:(s.enterClass||e+"-enter").split(" "),enterTo:(s.enterToClass||e+"-enter-to").split(" "),exitActive:(s.exitActiveClass||e+"-exit-active").split(" "),exit:(s.exitClass||e+"-exit").split(" "),exitTo:(s.exitToClass||e+"-exit-to").split(" ")}})}function it(s){requestAnimationFrame(()=>requestAnimationFrame(s))}function Ut(s,e,t,i,n){const{onBeforeEnter:a,onEnter:l,onAfterEnter:u}=e;let h;a?.(t),t.classList.add(...s.enter),t.classList.add(...s.enterActive),queueMicrotask(()=>{if(!t.parentNode)return i?.();l?.(t,()=>r())}),it(()=>{t.classList.remove(...s.enter),t.classList.add(...s.enterTo),(!l||l.length<2)&&(t.addEventListener("transitionend",r),t.addEventListener("animationend",r),n!==void 0&&(h=window.setTimeout(()=>r(),n)))});function r(d){(!d||d.target===t)&&(clearTimeout(h),i?.(),t.removeEventListener("transitionend",r),t.removeEventListener("animationend",r),t.classList.remove(...s.enterActive),t.classList.remove(...s.enterTo),u?.(t))}}function Nt(s,e,t,i,n){const{onBeforeExit:a,onExit:l,onAfterExit:u}=e;if(!t.parentNode)return i?.();let h;a?.(t),t.classList.add(...s.exit),t.classList.add(...s.exitActive),l?.(t,()=>r()),it(()=>{t.classList.remove(...s.exit),t.classList.add(...s.exitTo),(!l||l.length<2)&&(t.addEventListener("transitionend",r),t.addEventListener("animationend",r),n!==void 0&&(h=window.setTimeout(()=>r(),n)))});function r(d){(!d||d.target===t)&&(clearTimeout(h),i?.(),t.removeEventListener("transitionend",r),t.removeEventListener("animationend",r),t.classList.remove(...s.exitActive),t.classList.remove(...s.exitTo),u?.(t))}}var Rt=()=>{},K=(s,e)=>e();function Dt(s,e){const t=U(s),i=t?[t]:[],{onEnter:n=K,onExit:a=K}=e,[l,u]=E(e.appear?[]:i),[h]=dt();let r,d=!1;function o(c,_){if(!c)return _&&_();d=!0,a(c,()=>{N(()=>{d=!1,u(f=>f.filter(C=>C!==c)),_&&_()})})}function g(c){const _=r;if(!_)return c&&c();r=void 0,u(f=>[_,...f]),n(_,c??Rt)}const m=e.mode==="out-in"?c=>d||o(c,g):e.mode==="in-out"?c=>g(()=>o(c)):c=>{o(c),g()};return lt(c=>{const _=s();return U(h)?(h(),c):(_!==c&&(r=_,N(()=>U(()=>m(c)))),_)},e.appear?void 0:t),l}const Ft={inout:"in-out",outin:"out-in"},Jt=s=>{const e=At(s);return Dt(Lt(()=>s.children),{mode:Ft[s.mode],appear:s.appear,onEnter(t,i){Ut(e(),s,t,i,s.duration)},onExit(t,i){Nt(e(),s,t,i,s.duration)}})};function Mt(s){return(e,t,i)=>{s.addEventListener(e,t,i),J(()=>{s.removeEventListener(e,t,i)})}}function Zt(){const[s,e]=E(R.activeScreen);return Mt(R)("changeScreen",(t,i)=>e(i)),s}const zt=!1,Ot=tt&&_t,y=class y{constructor(){this.canvases=new Set}static getInstance(e){let t=this.INSTANCES.find(i=>i.options.element===e.element&&mt(i.options,e,["element"]));return t||(t=new y,t.init(e),this.INSTANCES.push(t)),t}init(e){this.options=e}renderToCanvas(e){return this.renderImageFromUrl(this.options.url).then(()=>this.fillCanvas(e))}renderImageFromUrl(e){if(this.renderImageFromUrlPromise)return this.renderImageFromUrlPromise;const t=this.image=document.createElement("img");return t.crossOrigin="anonymous",this.renderImageFromUrlPromise=Z(t,e,!1).then(()=>!tt||!Ot?t:createImageBitmap(t,{resizeWidth:1440,resizeHeight:2960}).then(i=>(this.imageBitmap=i,t)))}cleanup(e){this.canvases.delete(e),this.canvases.size||(ut(y.INSTANCES,this),this.imageBitmap?.close())}fillCanvas(e){const t=e.getContext("2d"),{width:i,height:n}=e,a=this.imageBitmap||this.image;let l=a.width,u=a.height;const h=(500+gt.height/2.5)*e.dpr,r=h/u;l*=r,u=h,this.options.mask?(t.fillStyle="#000",t.fillRect(0,0,i,n),t.globalCompositeOperation="destination-out"):t.globalCompositeOperation="source-over";const d=m=>{for(let c=0;c<i;c+=l)t.drawImage(a,c,m,l,u)},o=(n-u)/2;if(d(o),o>0){let m=o;do d(m-=u);while(m>=0)}const g=n-1;for(let m=o+u;m<g;m+=u)d(m)}setCanvasDimensions(e){const t=Math.min(2,window.devicePixelRatio),i=this.options.width*t;let n=this.options.height*t;e.dpr=t,e.dataset.originalHeight=""+n,R.activeScreen===ft.large&&zt&&(n*=1.5),e.width=i,e.height=n}createCanvas(){const e=document.createElement("canvas");return this.canvases.add(e),this.setCanvasDimensions(e),e}resize(e,t){this.init({...this.options,width:e,height:t});const i=[];for(const n of this.canvases)this.setCanvasDimensions(n),i.push(this.renderToCanvas(n));return Promise.all(i)}static resizeInstancesOf(e){const t=this.INSTANCES.filter(n=>n.options.element===e),i=e.getBoundingClientRect();return Promise.all(t.map(n=>n.resize(i.width,i.height)))}};y.INSTANCES=[];let b=y;const A=class A extends pt{static getWallPaperStorageUrl(e,t){return`backgrounds/${e}${t?"?blur":""}`}static hasWallPaperStorageUrl(e,t){const i=this.getWallPaperStorageUrl(e,t);return this.cacheStorage.has(i)}static getBackground({slug:e,canDownload:t,blur:i,managers:n,appDownloadManager:a}){var h;const l=this.getWallPaperStorageUrl(e,i),u=t&&!!n&&!!a;return(h=this.backgroundPromises)[l]||(h[l]=this.cacheStorage.getFile(l).then(r=>this.backgroundPromises[l]=URL.createObjectURL(r),u?async r=>{if(r.type!=="NO_ENTRY_FOUND")throw r;const d=await n.appThemesManager.getWallPaperBySlug(e);let o=await a.downloadMediaURL({media:d.document});return i&&(o=await this.blurWallPaperImage(o)),this.saveWallPaperToCache(e,o,i),this.backgroundPromises[l]=o}:void 0))}static blurWallPaperImage(e){const{canvas:t,promise:i}=vt(e,12,4);return i.then(()=>t.toDataURL())}static saveWallPaperToCache(e,t,i){if(!(!e||e===M))return fetch(t).then(n=>this.cacheStorage.save(this.getWallPaperStorageUrl(e,i),n))}static setBackgroundUrlToCache({slug:e,url:t,blur:i}){this.backgroundPromises[this.getWallPaperStorageUrl(e,i)]=t}};A.cacheStorage=new xt("cachedBackgrounds"),A.backgroundPromises={};let D=A;const Wt="_Container_nve2r_1",kt="_CanvasCommon_nve2r_11",Bt="_blend_nve2r_22",T={Container:Wt,CanvasCommon:kt,blend:Bt};function $t(s,e){return-e*s*(s-2)}const F=50,V=F;class z{constructor(){this._width=F,this._height=V,this._tails=90,this._curve=[0,.25,.5,.75,1,1.5,2,2.5,3,3.5,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,18.3,18.6,18.9,19.2,19.5,19.8,20.1,20.4,20.7,21,21.3,21.6,21.9,22.2,22.5,22.8,23.1,23.4,23.7,24,24.3,24.6,24.9,25.2,25.5,25.8,26.1,26.3,26.4,26.5,26.6,26.7,26.8,26.9,27],this._positions=[{x:.8,y:.1},{x:.6,y:.2},{x:.35,y:.25},{x:.25,y:.6},{x:.2,y:.9},{x:.4,y:.8},{x:.65,y:.75},{x:.75,y:.4}],this._phases=this._positions.length,this.drawNextPositionAnimated=t=>{let i,n;if(t){const a=t();i=a>=1;const l=$t(a,1),u=this._nextPositionTail??0,r=(this._nextPositionTail=this._nextPositionTails*l)-u;r&&(this._nextPositionLeft-=r,this.changeTailAndDraw(-r))}else{const a=this._frames;n=a.shift(),i=!a.length}return n&&this.drawImageData(n),i&&(this._nextPositionLeft=void 0,this._nextPositionTails=void 0,this._nextPositionTail=void 0,this._animatingToNextPosition=void 0),!i};const e=this._tails/this._curve[this._curve.length-1];for(let t=0,i=this._curve.length;t<i;++t)this._curve[t]=this._curve[t]*e;this._incrementalCurve=this._curve.map((t,i,n)=>t-(n[i-1]??0))}hexToRgb(e){const t=Pt(e);return{r:t[0],g:t[1],b:t[2]}}getPositions(e){const t=this._positions.slice();t.push(...t.splice(0,e));const i=[];for(let n=0;n<t.length;n+=2)i.push(t[n]);return i}getNextPositions(e,t,i){const n=this.getPositions(e);if(!i[0]&&i.length===1)return[n];const l=this.getPositions(++e%this._phases).map((h,r)=>({x:(h.x-n[r].x)/t,y:(h.y-n[r].y)/t}));return i.map(h=>l.map((r,d)=>({x:n[d].x+r.x*h,y:n[d].y+r.y*h})))}curPosition(e,t){return this.getNextPositions(e,this._tails,[t])[0]}changeTail(e){for(this._tail+=e;this._tail>=this._tails;)this._tail-=this._tails,++this._phase>=this._phases&&(this._phase-=this._phases);for(;this._tail<0;)this._tail+=this._tails,--this._phase<0&&(this._phase+=this._phases)}changeTailAndDraw(e){this.changeTail(e);const t=this.curPosition(this._phase,this._tail);this.drawGradient(t)}getGradientImageData(e,t=this._phase,i=1-this._tail/this._tails){const n=this._hctx.createImageData(this._width,this._height),a=n.data,l=this._colors.length,u=g=>{const m=[];for(let c=0;c!=4;++c)m[c]={...this._positions[(g+c*2)%this._positions.length]},m[c].y=1-m[c].y;return m},h=(t+1)%this._positions.length,r=u(h),d=u(t);let o=0;for(let g=0;g<this._height;++g){const c=g/this._height-.5,_=c*c;for(let f=0;f<this._width;++f){const P=f/this._width-.5,S=.35*Math.sqrt(P*P+_),p=S*S*.8*8,x=Math.sin(p),W=Math.cos(p),at=Math.max(0,Math.min(1,.5+P*W-c*x)),ot=Math.max(0,Math.min(1,.5+P*x+c*W));let I=0,k=0,B=0,$=0;for(let v=0;v<l;++v){const rt=r[v].x+(d[v].x-r[v].x)*i,ct=r[v].y+(d[v].y-r[v].y)*i,Y=at-rt,G=ot-ct;let w=Math.max(0,.9-Math.sqrt(Y*Y+G*G));w=w*w*w*w,I+=w,k+=w*this._colors[v].r,B+=w*this._colors[v].g,$+=w*this._colors[v].b}a[o++]=k/I,a[o++]=B/I,a[o++]=$/I,a[o++]=255}}return n}drawImageData(e){this._hctx.putImageData(e,0,0),this._ctx.drawImage(this._hc,0,0,this._width,this._height)}drawGradient(e){this.drawImageData(this.getGradientImageData(e))}init(e){this._frames=[],this._phase=0,this._tail=0;const t=e.getAttribute("data-colors").split(",");this._colors=t.map(i=>this.hexToRgb(i)),this._hc||(this._hc=document.createElement("canvas"),this._hc.width=this._width,this._hc.height=this._height,this._hctx=this._hc.getContext("2d",{alpha:!1})),this._canvas=e,this._ctx=this._canvas.getContext("2d",{alpha:!1}),this.update()}update(){if(this._colors.length<2){const t=this._colors[0];this._ctx.fillStyle=`rgb(${t.r}, ${t.g}, ${t.b})`,this._ctx.fillRect(0,0,this._width,this._height);return}const e=this.curPosition(this._phase,this._tail);this.drawGradient(e)}toNextPosition(e){if(this._colors.length<2)return;if(e){this._nextPositionLeft=this._tails+(this._nextPositionLeft??0),this._nextPositionTails=this._nextPositionLeft,this._nextPositionTail=void 0,this._animatingToNextPosition=!0,H(this.drawNextPositionAnimated.bind(this,e),this);return}const t=this._tail,i=this._tails;let n;const a=[];for(let h=0,r=this._incrementalCurve.length;h<r;++h){const d=this._incrementalCurve[h];let o=(a[h-1]??t)+d;+o.toFixed(2)>i&&n===void 0&&(n=h,o%=i),a.push(o)}const l=a.slice(0,n),u=n!==void 0?a.slice(n):[];[l,u].forEach((h,r,d)=>{const o=h[h.length-1];if(o!==void 0&&o>i&&(h[h.length-1]=+o.toFixed(2)),this._tail=o??0,!h.length)return;const g=this.getNextPositions(this._phase,i,h);r!==d.length-1&&++this._phase>=this._phases&&(this._phase-=this._phases);const m=g.map(c=>this.getGradientImageData(c));this._frames.push(...m)}),this._animatingToNextPosition=!0,H(this.drawNextPositionAnimated,this)}cleanup(){}static createCanvas(e){const t=document.createElement("canvas");return t.width=F,t.height=V,e!==void 0&&(t.dataset.colors=e),t}static create(e){const t=this.createCanvas(e),i=new z;return i.init(t),{gradientRenderer:i,canvas:t}}}function st(s){const e=s.getContext("2d"),t=new Array(4).fill(0),i=e.getImageData(0,0,s.width,s.height).data,n=i.length/4;for(let l=0;l<i.length;l+=4)t[0]+=i[l],t[1]+=i[l+1],t[2]+=i[l+2],t[3]+=i[l+3];const a=new Uint8ClampedArray(4);return a[0]=t[0]/n,a[1]=t[1]/n,a[2]=t[2]/n,a[3]=t[3]/n,a}function Yt(s,e,t){const i=document.createElement("canvas"),n=e/t,a=50;return n===1?(i.width=a,i.height=i.width/n):n>1?(i.height=a,i.width=i.height/n):i.width=i.height=a,i.getContext("2d").drawImage(s,0,0,e,t,0,0,i.width,i.height),st(i)}function nt(s){return Yt(s,s.naturalWidth,s.naturalHeight)}async function te(s){const e=document.createElement("img");return await Z(e,s,!1),nt(e)}function Gt(s){let{h:e,s:t,l:i}=Ct(s[0],s[1],s[2]);return t>0&&(t=Math.min(100,t+5+.1*(100-t))),i=Math.max(0,i*.65),`hsla(${e}, ${t}%, ${i}%, .4)`}const Ht=et("<div>"),Xt=et("<img>");async function qt(s){const{themeController:e,managers:t,peerId:i}=s;let n=e.getTheme(),a=e.getThemeSettings(n).wallpaper;if(i&&i.isUser()){const d=await t.appProfileManager.getCachedFullUser(i.toUserId());if(d?.wallpaper)a=d.wallpaper;else if(d?.theme_emoticon){const o=It.accountThemes.themes?.find(g=>g.emoticon===d.theme_emoticon);if(o){n=o;const g=o?.settings.find(m=>m.wallpaper)?.wallpaper;g&&(a=g)}}}let l;try{l=j(a.slug,a.settings?.pFlags.blur)}catch{l=j(M)}const u=!!a?.pFlags?.pattern,h=a.settings?.intensity&&a.settings.intensity/100,r=!!h&&h<0;return{theme:n,backgroundUrl:l,isPattern:u,isDarkPattern:r,intensity:h,wallPaper:a}}function j(s,e){return s===M?"assets/img/pattern.svg":D.getWallPaperStorageUrl(s,e)}async function Kt(s){s.naturalWidth||await new Promise(e=>{s.addEventListener("load",e,{once:!0})})}function ee(s){let e;const[t,i]=E(),[n,a]=E(),[l,u]=E(),[h,r]=E();async function d(){const{backgroundUrl:o,isPattern:g,isDarkPattern:m,intensity:c,wallPaper:_}=await qt(s);r(o);let f,C,P,O;if(o)if(g){const p=e.getBoundingClientRect(),x=b.getInstance({element:e,url:o,width:p.width,height:p.height,mask:m});C=x.createCanvas(),C.classList.add(T.CanvasCommon),m||C.classList.add(T.blend),x.renderToCanvas(C)}else f=document.createElement("img"),f.classList.add(T.CanvasCommon),Et(f,o);const S=St(_);if(S){const{canvas:p,gradientRenderer:x}=z.create(S);P=p,s.gradientRendererRef?.(x),P.classList.add(T.CanvasCommon)}else s.gradientRendererRef?.(void 0);if(c){let p;f?p=f:p=m?P:C;let x=Math.abs(c)*(m?.5:1);f?x=Math.max(.3,1-c):m&&(x=Math.max(.3,x)),p?.style.setProperty("--opacity-max",""+x)}if(N(()=>{i(C),a(P),u(f)}),s.onHighlightColor){let p;f?(await Kt(f),p=nt(f)):p=st(P);const x=Gt(Array.from(p));s.onHighlightColor(x)}return{patternRenderer:O}}return wt(()=>{const o=()=>{b.resizeInstancesOf(e)};window.addEventListener("resize",o);const g=d();J(()=>{window.removeEventListener("resize",o),g.then(({patternRenderer:m})=>{m?.cleanup(t())})})}),(()=>{const o=Ht(),g=e;return typeof g=="function"?yt(g,o):e=o,L(o,n,null),L(o,t,null),L(o,l,null),L(o,(()=>{const m=Q(()=>!!h());return()=>m()&&(()=>{const c=Xt();return X(c,T.CanvasCommon),c.style.setProperty("visibility","hidden"),q(()=>Tt(c,"src",h())),c})()})(),null),q(()=>X(o,bt(T.Container,s.class))),o})()}export{ee as C,Jt as T,D as a,b,z as c,nt as d,st as e,Qt as f,te as g,Gt as h,Mt as s,Zt as u};
//# sourceMappingURL=chatBackground-vDGLRJhn.js.map
